<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="assets/chessground.css">
  <link rel="stylesheet" href="assets/theme.css">
  <link rel="stylesheet" href="assets/examples.css">
</head>

<body>
  <div class="blue merida">
    <div id="dirty" class="cg-wrap"></div>
  </div>
  <script src="engine.js"></script>
  <script src="node_modules/chessground-sovereign/dist/chessground.js"></script>
  <script>
    function movelistToDests(movelist) {
      var dests = new Map();
      for (const move of movelist.split(' ')) {
        // temporary hacky, TODO(samkhal) add proper protocol
        const from = move.slice(0, 2);
        const to = move.slice(2, 4);
        if (dests.has(from)) {
          dests.get(from).push(to);
        } else {
          dests.set(from, [to]);
        }
      }
      console.log(dests);
      return dests;
    }

    function playOtherSide(cg) {
      return (orig, dest) => {
        var new_fen = cg.getFen();
        new_fen += " ";
        new_fen += cg.state.turnColor === 'white' ? 'w' : 'b';
        cg.set({
          movable: {
            color: cg.state.turnColor,
            dests: movelistToDests(getLegalMoves(new_fen))
          }
        });
      };
    }

    const getLegalMoves = Module.cwrap('get_legal_moves', 'string', ['string']);
    const initialFEN = '4rnbqkbnr4/4pppppppp4/16/16/16/16/16/16/16/16/16/16/16/16/4PPPPPPPP4/4RNBQKBNR4';
    Module['onRuntimeInitialized'] = function () {
      var cg = Chessground(document.getElementById('dirty'), {
        fen: initialFEN,
        premovable: {
          enabled: false
        },
        drawable: {
          enabled: false
        },
        movable: {
          color: 'white',
          free: false,
          dests: movelistToDests(getLegalMoves(initialFEN)),
        },
      });
      cg.set({
        movable: { events: { after: playOtherSide(cg) } }
      });
    };

  </script>
</body>

</html>