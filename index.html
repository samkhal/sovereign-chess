<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="assets/chessground.css">
  <link rel="stylesheet" href="assets/theme.css">
  <link rel="stylesheet" href="assets/examples.css">
  <script src="svg-inject.min.js"></script>
  <script>
    SVGInject.setOptions({
      makeIdsUnique: false, // can't remap ids because it'd mangle symbol ids too
    });
  </script>
</head>

<body>

  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/pawn.svg" onload="SVGInject(this)" />
  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/rook.svg" onload="SVGInject(this)" />
  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/queen.svg" onload="SVGInject(this)" />
  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/king.svg" onload="SVGInject(this)" />
  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/bishop.svg" onload="SVGInject(this)" />
  <img class="piece-template" src="assets/images/pieces/merida-solid-transparent/knight.svg" onload="SVGInject(this)" />

  <div class="blue merida">
    <div id="dirty" class="cg-wrap"></div>
    <button id="legal-toggle">Toggle legal moves</button>
  </div>

  <script src="engine.js"></script>
  <script src="node_modules/chessground-sovereign/dist/chessground.js"></script>
  <script>
    var legal_moves_only = true;

    function movelistToDests(movelist) {
      var dests = new Map();
      for (const move of movelist.split(' ')) {
        // temporary hacky, TODO(samkhal) add proper protocol
        const from = move.slice(0, 2);
        const to = move.slice(2, 4);
        if (dests.has(from)) {
          dests.get(from).push(to);
        } else {
          dests.set(from, [to]);
        }
      }
      console.log(dests);
      return dests;
    }

    function playOtherSide(cg) {
      return (orig, dest) => {
        var new_fen = cg.getFen();
        new_fen += " ";
        new_fen += cg.state.turnPlayer === 'white' ? 'w' : 'b';
        cg.set({
          movable: {
            // TODO with legal moves on, we should only allow moving one color; but without this, we can still rely on legal moves for filtering
            // color: window.legal_moves_only ? cg.state.turnPlayer : "both",
            dests: movelistToDests(getLegalMoves(new_fen))
          }
        });
      };
    }

    const getLegalMoves = Module.cwrap('get_legal_moves', 'string', ['string']);
    Module['onRuntimeInitialized'] = function () {
      var cg = Chessground(document.getElementById('dirty'), {
        premovable: {
          enabled: false
        },
        drawable: {
          enabled: false
        },
        movable: {
          color: 'both',
          free: false,
        },
        highlight: {
          lastMove: false,
        }
      });
      cg.set({
        movable: {
          dests: movelistToDests(getLegalMoves(cg.getFen())),
          events: { after: playOtherSide(cg) }
        }
      });
      console.log(cg);

      function toggleLegalMoves() {
        window.legal_moves_only = !window.legal_moves_only;
        console.log("legal toggle", window.legal_moves_only);
        cg.set({
          movable: {
            free: !window.legal_moves_only,
            // TODO with legal moves on, we should only allow moving one color; but without this, we can still rely on legal moves for filtering
            // color: window.legal_moves_only ? "white" : "both"
          }
        });
      }

      document.getElementById('legal-toggle').onclick = () => toggleLegalMoves();
    };

  </script>
</body>

</html>